<!--
  Archivo: frontend/src/app/pages/admin-usuarios/admin-usuarios.page.html
  Descripción: Template HTML para la gestión de usuarios del administrador
  Autor: Sistema de Gestión de Tickets
  Fecha: 2025
-->

<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin-home"></ion-back-button>
    </ion-buttons>
    <ion-title>Gestión de Usuarios</ion-title>
    
    <!-- Botón de refrescar -->
    <ion-buttons slot="end">
      <ion-button (click)="refrescar()" [disabled]="cargando">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  
  <!-- Encabezado con botón crear usuario -->
  <div class="header-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">
        <ion-icon name="people-outline" class="me-2"></ion-icon>
        Usuarios del Sistema
      </h2>
      
      <!-- Botón crear usuario -->
      <ion-button 
        (click)="irACrearUsuario()" 
        color="success" 
        fill="solid"
        [disabled]="cargando">
        <ion-icon name="add-outline" slot="start"></ion-icon>
        Crear Usuario
      </ion-button>
    </div>
    
    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
      <div class="col-md-3 col-6 mb-2">
        <div class="stat-card bg-primary text-white">
          <div class="stat-number">{{ usuarios.length }}</div>
          <div class="stat-label">Total Usuarios</div>
        </div>
      </div>
      <div class="col-md-3 col-6 mb-2">
        <div class="stat-card bg-success text-white">
          <div class="stat-number">{{ obtenerUsuariosActivos() }}</div>
          <div class="stat-label">Total Usuarios</div>
        </div>
      </div>
      <div class="col-md-3 col-6 mb-2">
        <div class="stat-card bg-info text-white">
          <div class="stat-number">{{ obtenerAdministradores() }}</div>
          <div class="stat-label">Administradores</div>
        </div>
      </div>
      <div class="col-md-3 col-6 mb-2">
        <div class="stat-card bg-warning text-white">
          <div class="stat-number">{{ departamentos.length }}</div>
          <div class="stat-label">Departamentos</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección de filtros -->
  <ion-card class="filtros-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="filter-outline" class="me-2"></ion-icon>
        Filtros de Búsqueda
      </ion-card-title>
    </ion-card-header>
    
    <ion-card-content>
      <form [formGroup]="formularioFiltros">
        <div class="row">
          
          <!-- Búsqueda por nombre -->
          <div class="col-md-4 col-12 mb-3">
            <ion-item fill="outline">
              <ion-label position="stacked">Buscar por nombre</ion-label>
              <ion-input 
                formControlName="busqueda"
                placeholder="Ingresa nombre del usuario"
                clearInput="true">
              </ion-input>
            </ion-item>
          </div>

          <!-- Filtro por departamento -->
          <div class="col-md-4 col-12 mb-3">
            <ion-item fill="outline">
              <ion-label position="stacked">Departamento</ion-label>
              <ion-select 
                formControlName="departamento"
                placeholder="Todos los departamentos"
                interface="popover"
                (ionChange)="onCambioDepartamento($event)">
                <ion-select-option value="">Todos</ion-select-option>
                <ion-select-option 
                  *ngFor="let departamento of departamentos" 
                  [value]="departamento.id">
                  {{ departamento.nombre }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </div>

          <!-- Filtro por rol -->
          <div class="col-md-4 col-12 mb-3">
            <ion-item fill="outline">
              <ion-label position="stacked">Rol</ion-label>
              <ion-select 
                formControlName="rol"
                placeholder="Todos los roles"
                interface="popover"
                (ionChange)="onCambioRol($event)">
                <ion-select-option value="">Todos</ion-select-option>
                <ion-select-option 
                  *ngFor="let opcion of opcionesRol" 
                  [value]="opcion.valor">
                  {{ opcion.etiqueta }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </div>
        </div>

        <!-- Botones de filtros -->
        <div class="d-flex gap-2 mt-3">
          <ion-button 
            (click)="aplicarFiltros()" 
            color="primary" 
            fill="solid"
            [disabled]="cargando">
            <ion-icon name="search-outline" slot="start"></ion-icon>
            Aplicar Filtros
          </ion-button>
          
          <ion-button 
            (click)="limpiarFiltros()" 
            color="medium" 
            fill="outline"
            [disabled]="cargando">
            <ion-icon name="close-outline" slot="start"></ion-icon>
            Limpiar
          </ion-button>
        </div>
      </form>
    </ion-card-content>
  </ion-card>

  <!-- Tabla de usuarios -->
  <ion-card class="usuarios-table-card">
    <ion-card-header>
      <ion-card-title>
        <div class="d-flex justify-content-between align-items-center">
          <span>
            <ion-icon name="list-outline" class="me-2"></ion-icon>
            Lista de Usuarios ({{ paginacion.totalElementos }})
          </span>
          
          <!-- Información de paginación -->
          <span class="text-muted small">
            Página {{ paginacion.paginaActual }} de {{ paginacion.totalPaginas }}
          </span>
        </div>
      </ion-card-title>
    </ion-card-header>

    <ion-card-content class="p-0">
      
      <!-- Loading state -->
      <div *ngIf="cargando" class="text-center p-4">
        <ion-spinner name="circular"></ion-spinner>
        <p class="mt-2 text-muted">Cargando usuarios...</p>
      </div>

      <!-- Estado vacío -->
      <div *ngIf="!cargando && usuarios.length === 0" class="text-center p-5">
        <ion-icon name="people-outline" size="large" class="text-muted"></ion-icon>
        <h4 class="mt-3 text-muted">No hay usuarios</h4>
        <p class="text-muted">No se encontraron usuarios con los filtros aplicados.</p>
        <ion-button (click)="limpiarFiltros()" fill="outline" color="primary">
          Limpiar Filtros
        </ion-button>
      </div>

      <!-- Tabla responsive -->
      <div *ngIf="!cargando && usuarios.length > 0" class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th>
                <ion-icon name="person-outline" class="me-1"></ion-icon>
                Usuario
              </th>
              <th>
                <ion-icon name="mail-outline" class="me-1"></ion-icon>
                Email
              </th>
              <th>
                <ion-icon name="card-outline" class="me-1"></ion-icon>
                RUT
              </th>
              <th>
                <ion-icon name="business-outline" class="me-1"></ion-icon>
                Departamento
              </th>
              <th>
                <ion-icon name="shield-outline" class="me-1"></ion-icon>
                Rol
              </th>
              <th>
                <ion-icon name="checkmark-circle-outline" class="me-1"></ion-icon>
                Estado
              </th>
              <th>
                <ion-icon name="calendar-outline" class="me-1"></ion-icon>
                Último Acceso
              </th>
              <th class="text-center">
                <ion-icon name="settings-outline" class="me-1"></ion-icon>
                Acciones
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let usuario of obtenerUsuariosPaginados()">
              
              <!-- Información del usuario -->
              <td>
                <div class="d-flex align-items-center">
                  <div class="user-avatar me-2">
                    <ion-icon name="person-circle-outline" size="large"></ion-icon>
                  </div>
                  <div>
                    <div class="fw-bold">{{ usuario.nombre }}</div>
                    <small class="text-muted">ID: {{ usuario.id }}</small>
                  </div>
                </div>
              </td>

              <!-- Email -->
              <td>
                <a [href]="'mailto:' + usuario.email" class="text-decoration-none">
                  {{ usuario.email }}
                </a>
              </td>

              <!-- RUT -->
              <td>
                <code class="bg-light p-1 rounded">{{ usuario.rut }}</code>
              </td>

              <!-- Departamento -->
              <td>
                <span class="badge bg-info">
                  {{ obtenerNombreDepartamento(usuario.id_departamento) }}
                </span>
              </td>

              <!-- Rol -->
              <td>
                <span class="badge bg-secondary">
                  {{ obtenerEtiquetaRol(usuario.rol) }}
                </span>
              </td>

              <!-- Estado (siempre activo) -->
              <td>
                <span [class]="obtenerClaseEstado()">
                  <ion-icon 
                    name="checkmark-circle"
                    class="me-1">
                  </ion-icon>
                  {{ obtenerTextoEstado() }}
                </span>
              </td>

              <!-- Último acceso -->
              <td>
                <span *ngIf="usuario.ultimo_acceso; else sinAcceso" class="small">
                  {{ usuario.ultimo_acceso | date:'dd/MM/yyyy HH:mm' }}
                </span>
                <ng-template #sinAcceso>
                  <span class="text-muted small">Nunca</span>
                </ng-template>
              </td>

              <!-- Acciones -->
              <td class="text-center">
                <div class="btn-group" role="group">
                  
                  <!-- Botón editar -->
                  <ion-button 
                    (click)="irAEditarUsuario(usuario)"
                    fill="clear" 
                    size="small" 
                    color="primary"
                    [disabled]="cargando">
                    <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                  </ion-button>

                  <!-- Botón eliminar -->
                  <ion-button 
                    (click)="eliminarUsuario(usuario)"
                    fill="clear" 
                    size="small" 
                    color="danger"
                    [disabled]="cargando">
                    <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      <div *ngIf="!cargando && usuarios.length > 0 && paginacion.totalPaginas > 1" 
           class="d-flex justify-content-center p-3 border-top">
        <nav aria-label="Paginación de usuarios">
          <ul class="pagination mb-0">
            
            <!-- Botón anterior -->
            <li class="page-item" [class.disabled]="paginacion.paginaActual === 1">
              <button 
                class="page-link" 
                (click)="cambiarPagina(paginacion.paginaActual - 1)"
                [disabled]="paginacion.paginaActual === 1 || cargando">
                <ion-icon name="chevron-back-outline"></ion-icon>
              </button>
            </li>

            <!-- Números de página -->
            <li *ngFor="let pagina of obtenerNumerosPaginas()" 
                class="page-item" 
                [class.active]="pagina === paginacion.paginaActual">
              <button 
                class="page-link" 
                (click)="cambiarPagina(pagina)"
                [disabled]="cargando">
                {{ pagina }}
              </button>
            </li>

            <!-- Botón siguiente -->
            <li class="page-item" 
                [class.disabled]="paginacion.paginaActual === paginacion.totalPaginas">
              <button 
                class="page-link" 
                (click)="cambiarPagina(paginacion.paginaActual + 1)"
                [disabled]="paginacion.paginaActual === paginacion.totalPaginas || cargando">
                <ion-icon name="chevron-forward-outline"></ion-icon>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Botón flotante para crear usuario en móviles -->
  <ion-fab 
    vertical="bottom" 
    horizontal="end" 
    slot="fixed"
    class="d-md-none">
    <ion-fab-button (click)="irACrearUsuario()" color="success">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>