<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin-home"></ion-back-button>
    </ion-buttons>
    <ion-title>Gestión de Usuarios</ion-title>
    
    <!-- Botón de refrescar -->
    <ion-buttons slot="end">
      <ion-button (click)="refrescar()" [disabled]="cargando">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  
  <!-- Encabezado con botón crear usuario -->
  <div class="header-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">
        <ion-icon name="people-outline" class="me-2"></ion-icon>
        Usuarios del Sistema
      </h2>
      
      <!-- Botón crear usuario -->
      <ion-button 
        (click)="irACrearUsuario()" 
        color="success" 
        fill="solid"
        [disabled]="cargando">
        <ion-icon name="add-outline" slot="start"></ion-icon>
        Crear Usuario
      </ion-button>
    </div>
    
    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
      <div class="col-md-3 col-6 mb-2">
        <div class="stat-card bg-primary text-white">
          <div class="stat-number">{{ usuarios.length }}</div>
          <div class="stat-label">Total Usuarios</div>
        </div>
      </div>
      <div class="col-md-3 col-6 mb-2">
        <div class="stat-card bg-success text-white">
          <div class="stat-number">{{ obtenerUsuariosActivos() }}</div>
          <div class="stat-label">Usuarios Activos</div>
        </div>
      </div>
      <div class="col-md-3 col-6 mb-2">
        <div class="stat-card bg-info text-white">
          <div class="stat-number">{{ obtenerAdministradores() }}</div>
          <div class="stat-label">Administradores</div>
        </div>
      </div>
      <div class="col-md-3 col-6 mb-2">
        <div class="stat-card bg-warning text-white">
          <div class="stat-number">{{ obtenerUsuariosPorDepartamento() }}</div>
          <div class="stat-label">Departamentos</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección de filtros -->
  <div class="filters-section mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <ion-icon name="filter-outline" class="me-2"></ion-icon>
          Filtros de Búsqueda
        </h5>
      </div>
      <div class="card-body">
        <form [formGroup]="formularioFiltros" class="row g-3">
          
          <!-- Filtro por nombre -->
          <div class="col-md-4">
            <label class="form-label">Nombre o Email</label>
            <ion-input
              formControlName="busqueda"
              placeholder="Buscar por nombre o email..."
              fill="outline"
              class="w-100">
            </ion-input>
          </div>

          <!-- Filtro por departamento -->
          <div class="col-md-3">
            <label class="form-label">Departamento</label>
            <ion-select 
              formControlName="departamento" 
              placeholder="Todos"
              fill="outline">
              <ion-select-option value="">Todos los departamentos</ion-select-option>
              <ion-select-option value="1">Administración</ion-select-option>
              <ion-select-option value="2">Comercial</ion-select-option>
              <ion-select-option value="3">Informática</ion-select-option>
              <ion-select-option value="4">Operaciones</ion-select-option>
            </ion-select>
          </div>

          <!-- Filtro por rol -->
          <div class="col-md-3">
            <label class="form-label">Rol</label>
            <ion-select 
              formControlName="rol" 
              placeholder="Todos"
              fill="outline">
              <ion-select-option value="">Todos los roles</ion-select-option>
              <ion-select-option 
                *ngFor="let opcion of opcionesRol" 
                [value]="opcion.valor">
                {{ opcion.etiqueta }}
              </ion-select-option>
            </ion-select>
          </div>

          <!-- Botones de acción -->
          <div class="col-md-2 d-flex align-items-end">
            <div class="btn-group w-100" role="group">
              <ion-button 
                (click)="aplicarFiltros()" 
                color="primary" 
                size="small"
                [disabled]="cargando">
                <ion-icon name="search-outline" slot="start"></ion-icon>
                Buscar
              </ion-button>
              <ion-button 
                (click)="limpiarFiltros()" 
                color="light" 
                size="small"
                [disabled]="cargando">
                <ion-icon name="close-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Loading spinner -->
  <div *ngIf="cargando" class="text-center my-4">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p class="mt-2 text-muted">Cargando usuarios...</p>
  </div>

  <!-- Tabla de usuarios -->
  <div *ngIf="!cargando" class="table-section">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Lista de Usuarios</h5>
        <span class="badge bg-secondary">{{ usuarios.length }} usuarios</span>
      </div>
      <div class="card-body p-0">
        
        <!-- Mensaje si no hay usuarios -->
        <div *ngIf="usuarios.length === 0" class="text-center py-5">
          <ion-icon name="people-outline" size="large" class="text-muted mb-3"></ion-icon>
          <p class="text-muted mb-3">No se encontraron usuarios</p>
          <ion-button (click)="irACrearUsuario()" color="primary">
            <ion-icon name="add-outline" slot="start"></ion-icon>
            Crear primer usuario
          </ion-button>
        </div>

        <!-- Tabla con usuarios -->
        <div *ngIf="usuarios.length > 0" class="table-responsive">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
              <tr>
                <th scope="col">ID</th>
                <th scope="col">Nombre</th>
                <th scope="col">Email</th>
                <th scope="col">RUT</th>
                <th scope="col">Departamento</th>
                <th scope="col">Rol</th>
                <!-- ✅ CORREGIDO: Columna Estado eliminada completamente -->
                <th scope="col">Último Acceso</th>
                <th scope="col" class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let usuario of obtenerUsuariosPaginados(); trackBy: trackByUsuarioId">
                
                <!-- ID del usuario -->
                <td>
                  <span class="badge bg-light text-dark">#{{ usuario.id }}</span>
                </td>

                <!-- Nombre completo -->
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar-circle me-2">
                      {{ obtenerIniciales(usuario.nombre) }}
                    </div>
                    <div>
                      <strong>{{ usuario.nombre }}</strong>
                    </div>
                  </div>
                </td>

                <!-- Email -->
                <td>
                  <a 
                    [href]="'mailto:' + usuario.email" 
                    class="text-decoration-none">
                    {{ usuario.email }}
                  </a>
                </td>

                <!-- ✅ CORREGIDO: RUT real desde base de datos -->
                <td>
                  <code class="bg-light p-1 rounded">{{ usuario.rut || 'Sin RUT' }}</code>
                </td>

                <!-- Departamento con código y nombre -->
                <td>
                  <span class="badge" [ngClass]="obtenerClaseDepartamento(usuario.id_departamento)">
                    {{ obtenerNombreDepartamento(usuario.id_departamento) }}
                    <small class="ms-1">({{ usuario.id_departamento }})</small>
                  </span>
                </td>

                <!-- Rol -->
                <td>
                  <span class="badge" [ngClass]="obtenerClaseRol(usuario.rol)">
                    {{ obtenerEtiquetaRol(usuario.rol) }}
                  </span>
                </td>

                <!-- ✅ CORREGIDO: Campo Estado eliminado completamente -->

                <!-- Último acceso -->
                <td>
                  <span *ngIf="usuario.ultimo_acceso; else sinAcceso" class="small">
                    {{ usuario.ultimo_acceso | date:'dd/MM/yyyy HH:mm' }}
                  </span>
                  <ng-template #sinAcceso>
                    <span class="text-muted small">Nunca</span>
                  </ng-template>
                </td>

                <!-- Acciones -->
                <td class="text-center">
                  <div class="btn-group" role="group">
                    
                    <!-- Botón ver detalles -->
                    <ion-button 
                      (click)="verDetalleUsuario(usuario)"
                      fill="clear" 
                      size="small" 
                      color="primary"
                      [disabled]="cargando">
                      <ion-icon name="eye-outline" slot="icon-only"></ion-icon>
                    </ion-button>

                    <!-- Botón editar -->
                    <ion-button 
                      (click)="irAEditarUsuario(usuario)"
                      fill="clear" 
                      size="small" 
                      color="warning"
                      [disabled]="cargando">
                      <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                    </ion-button>

                    <!-- Botón eliminar -->
                    <ion-button 
                      (click)="eliminarUsuario(usuario)"
                      fill="clear" 
                      size="small" 
                      color="danger"
                      [disabled]="cargando">
                      <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Paginación -->
  <div *ngIf="!cargando && usuarios.length > 0" class="pagination-section mt-4">
    <div class="d-flex justify-content-between align-items-center">
      
      <!-- Información de paginación -->
      <div class="pagination-info">
        <small class="text-muted">
          Mostrando {{ (paginacion.paginaActual - 1) * paginacion.elementosPorPagina + 1 }} 
          al {{ Math.min(paginacion.paginaActual * paginacion.elementosPorPagina, usuarios.length) }}
          de {{ usuarios.length }} usuarios
        </small>
      </div>

      <!-- Controles de paginación -->
      <nav *ngIf="paginacion.totalPaginas > 1">
        <ul class="pagination pagination-sm mb-0">
          
          <!-- Botón anterior -->
          <li class="page-item" [class.disabled]="paginacion.paginaActual === 1">
            <button 
              class="page-link" 
              (click)="irAPagina(paginacion.paginaActual - 1)"
              [disabled]="paginacion.paginaActual === 1">
              Anterior
            </button>
          </li>

          <!-- Números de página -->
          <li 
            *ngFor="let pagina of obtenerNumerosPaginas()" 
            class="page-item"
            [class.active]="pagina === paginacion.paginaActual">
            <button 
              class="page-link" 
              (click)="irAPagina(pagina)">
              {{ pagina }}
            </button>
          </li>

          <!-- Botón siguiente -->
          <li class="page-item" [class.disabled]="paginacion.paginaActual === paginacion.totalPaginas">
            <button 
              class="page-link" 
              (click)="irAPagina(paginacion.paginaActual + 1)"
              [disabled]="paginacion.paginaActual === paginacion.totalPaginas">
              Siguiente
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Botón flotante para crear usuario en móvil -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button 
      color="success" 
      (click)="irACrearUsuario()"
      [disabled]="cargando">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>