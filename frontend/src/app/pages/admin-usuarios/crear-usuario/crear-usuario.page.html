<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button 
        defaultHref="/admin-usuarios" 
        (click)="volver()">
      </ion-back-button>
    </ion-buttons>
    <ion-title>Crear Nuevo Usuario</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  
  <!-- Encabezado de la página -->
  <div class="header-section mb-4">
    <div class="d-flex align-items-center mb-3">
      <ion-icon name="person-add-outline" size="large" class="me-3 text-primary"></ion-icon>
      <div>
        <h2 class="mb-1">Crear Nuevo Usuario</h2>
        <p class="text-muted mb-0">Completa el formulario para agregar un nuevo usuario al sistema</p>
      </div>
    </div>
  </div>

  <!-- Formulario principal -->
  <form [formGroup]="formularioUsuario" (ngSubmit)="onSubmit()" *ngIf="!cargando">
    
    <!-- SECCIÓN: Información Personal -->
    <ion-card class="form-section">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="person-outline" class="me-2"></ion-icon>
          Información Personal
        </ion-card-title>
        <ion-card-subtitle>
          Datos básicos del usuario
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div class="row">
          
          <!-- Campo: Primer Nombre -->
          <div class="col-md-6 col-12 mb-3">
            <ion-item 
              fill="outline" 
              [class.ion-invalid]="errores.primer_nombre"
              [class.ion-valid]="!errores.primer_nombre && formularioUsuario.get('primer_nombre')?.touched">
              <ion-label position="stacked">
                Primer Nombre <span class="text-danger">*</span>
              </ion-label>
              <ion-input 
                formControlName="primer_nombre"
                placeholder="Ingresa el primer nombre"
                (ionBlur)="onCampoFormulario()"
                clearInput="true">
              </ion-input>
              <ion-note slot="helper">
                Solo letras, mínimo 2 caracteres, máximo 25
              </ion-note>
              <ion-note slot="error" *ngIf="errores.primer_nombre">
                {{ errores.primer_nombre }}
              </ion-note>
            </ion-item>
          </div>

          <!-- Campo: Segundo Nombre (Opcional) -->
          <div class="col-md-6 col-12 mb-3">
            <ion-item 
              fill="outline" 
              [class.ion-invalid]="errores.segundo_nombre"
              [class.ion-valid]="!errores.segundo_nombre && formularioUsuario.get('segundo_nombre')?.touched">
              <ion-label position="stacked">
                Segundo Nombre <span class="text-muted">(Opcional)</span>
              </ion-label>
              <ion-input 
                formControlName="segundo_nombre"
                placeholder="Ingresa el segundo nombre"
                (ionBlur)="onCampoFormulario()"
                clearInput="true">
              </ion-input>
              <ion-note slot="helper">
                Solo letras, máximo 25 caracteres
              </ion-note>
              <ion-note slot="error" *ngIf="errores.segundo_nombre">
                {{ errores.segundo_nombre }}
              </ion-note>
            </ion-item>
          </div>

          <!-- Campo: Primer Apellido -->
          <div class="col-md-6 col-12 mb-3">
            <ion-item 
              fill="outline" 
              [class.ion-invalid]="errores.primer_apellido"
              [class.ion-valid]="!errores.primer_apellido && formularioUsuario.get('primer_apellido')?.touched">
              <ion-label position="stacked">
                Primer Apellido <span class="text-danger">*</span>
              </ion-label>
              <ion-input 
                formControlName="primer_apellido"
                placeholder="Ingresa el primer apellido"
                (ionBlur)="onCampoFormulario()"
                clearInput="true">
              </ion-input>
              <ion-note slot="helper">
                Solo letras, mínimo 2 caracteres, máximo 25
              </ion-note>
              <ion-note slot="error" *ngIf="errores.primer_apellido">
                {{ errores.primer_apellido }}
              </ion-note>
            </ion-item>
          </div>

          <!-- Campo: Segundo Apellido -->
          <div class="col-md-6 col-12 mb-3">
            <ion-item 
              fill="outline" 
              [class.ion-invalid]="errores.segundo_apellido"
              [class.ion-valid]="!errores.segundo_apellido && formularioUsuario.get('segundo_apellido')?.touched">
              <ion-label position="stacked">
                Segundo Apellido <span class="text-danger">*</span>
              </ion-label>
              <ion-input 
                formControlName="segundo_apellido"
                placeholder="Ingresa el segundo apellido"
                (ionBlur)="onCampoFormulario()"
                clearInput="true">
              </ion-input>
              <ion-note slot="helper">
                Solo letras, mínimo 2 caracteres, máximo 25
              </ion-note>
              <ion-note slot="error" *ngIf="errores.segundo_apellido">
                {{ errores.segundo_apellido }}
              </ion-note>
            </ion-item>
          </div>
          
        </div>
      </ion-card-content>
    </ion-card>

    <!-- SECCIÓN: Información de Contacto -->
    <ion-card class="form-section">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="mail-outline" class="me-2"></ion-icon>
          Información de Contacto
        </ion-card-title>
        <ion-card-subtitle>
          Datos de contacto y acceso
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div class="row">
          
          <!-- Campo: RUT -->
          <div class="col-md-6 col-12 mb-3">
            <ion-item 
              fill="outline" 
              [class.ion-invalid]="errores.rut"
              [class.ion-valid]="!errores.rut && formularioUsuario.get('rut')?.touched">
              <ion-label position="stacked">
                RUT <span class="text-danger">*</span>
              </ion-label>
              <ion-input 
                formControlName="rut"
                placeholder="12345678-9"
                (ionBlur)="onCampoFormulario()"
                clearInput="true">
              </ion-input>
              <ion-note slot="helper">
                Formato: 12345678-9
              </ion-note>
              <ion-note slot="error" *ngIf="errores.rut">
                {{ errores.rut }}
              </ion-note>
            </ion-item>
          </div>

          <!-- Campo: Correo Electrónico -->
          <div class="col-md-6 col-12 mb-3">
            <ion-item 
              fill="outline" 
              [class.ion-invalid]="errores.correo"
              [class.ion-valid]="!errores.correo && formularioUsuario.get('correo')?.touched">
              <ion-label position="stacked">
                Correo Electrónico <span class="text-danger">*</span>
              </ion-label>
              <ion-input 
                formControlName="correo"
                type="email"
                placeholder="correo@ejemplo.com"
                (ionBlur)="onCampoFormulario()"
                clearInput="true">
              </ion-input>
              <ion-note slot="helper">
                Debe ser un correo válido, máximo 80 caracteres
              </ion-note>
              <ion-note slot="error" *ngIf="errores.correo">
                {{ errores.correo }}
              </ion-note>
            </ion-item>
          </div>
          
        </div>
      </ion-card-content>
    </ion-card>

    <!-- SECCIÓN: Seguridad -->
    <ion-card class="form-section">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="lock-closed-outline" class="me-2"></ion-icon>
          Seguridad
        </ion-card-title>
        <ion-card-subtitle>
          Configuración de contraseña
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div class="row">
          
          <!-- Campo: Contraseña -->
          <div class="col-md-6 col-12 mb-3">
            <ion-item 
              fill="outline" 
              [class.ion-invalid]="errores.contrasena"
              [class.ion-valid]="!errores.contrasena && formularioUsuario.get('contrasena')?.touched">
              <ion-label position="stacked">
                Contraseña <span class="text-danger">*</span>
              </ion-label>
              <ion-input 
                formControlName="contrasena"
                type="password"
                placeholder="Ingresa una contraseña segura"
                (ionBlur)="onCampoFormulario()">
              </ion-input>
              <ion-note slot="helper">
                Mínimo 8 caracteres, incluir mayúscula, minúscula, número y carácter especial
              </ion-note>
              <ion-note slot="error" *ngIf="errores.contrasena">
                {{ errores.contrasena }}
              </ion-note>
            </ion-item>
          </div>

          <!-- Campo: Confirmar Contraseña -->
          <div class="col-md-6 col-12 mb-3">
            <ion-item 
              fill="outline" 
              [class.ion-invalid]="errores.confirmarContrasena"
              [class.ion-valid]="!errores.confirmarContrasena && formularioUsuario.get('confirmarContrasena')?.touched">
              <ion-label position="stacked">
                Confirmar Contraseña <span class="text-danger">*</span>
              </ion-label>
              <ion-input 
                formControlName="confirmarContrasena"
                type="password"
                placeholder="Confirma la contraseña"
                (ionBlur)="onCampoFormulario()">
              </ion-input>
              <ion-note slot="helper">
                Debe coincidir con la contraseña anterior
              </ion-note>
              <ion-note slot="error" *ngIf="errores.confirmarContrasena">
                {{ errores.confirmarContrasena }}
              </ion-note>
            </ion-item>
          </div>
          
        </div>
      </ion-card-content>
    </ion-card>

    <!-- SECCIÓN: Información Organizacional -->
    <ion-card class="form-section">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="business-outline" class="me-2"></ion-icon>
          Información Organizacional
        </ion-card-title>
        <ion-card-subtitle>
          Departamento y rol del usuario
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div class="row">
          
          <!-- Campo: Departamento -->
          <div class="col-md-6 col-12 mb-3">
            <ion-item 
              fill="outline" 
              [class.ion-invalid]="errores.id_departamento"
              [class.ion-valid]="!errores.id_departamento && formularioUsuario.get('id_departamento')?.touched">
              <ion-label position="stacked">
                Departamento <span class="text-danger">*</span>
              </ion-label>
              <ion-select 
                formControlName="id_departamento"
                placeholder="Selecciona un departamento"
                (ionChange)="onCampoFormulario()"
                interface="popover">
                <ion-select-option 
                  *ngFor="let departamento of departamentos" 
                  [value]="departamento.id">
                  {{ departamento.nombre }}
                </ion-select-option>
              </ion-select>
              <ion-note slot="helper">
                Departamento al que pertenecerá el usuario
              </ion-note>
              <ion-note slot="error" *ngIf="errores.id_departamento">
                {{ errores.id_departamento }}
              </ion-note>
            </ion-item>
          </div>

          <!-- Campo: Rol -->
          <div class="col-md-6 col-12 mb-3">
            <ion-item 
              fill="outline" 
              [class.ion-invalid]="errores.rol"
              [class.ion-valid]="!errores.rol && formularioUsuario.get('rol')?.touched">
              <ion-label position="stacked">
                Rol <span class="text-danger">*</span>
              </ion-label>
              <ion-select 
                formControlName="rol"
                placeholder="Selecciona un rol"
                (ionChange)="onCampoFormulario()"
                interface="popover">
                <ion-select-option 
                  *ngFor="let opcion of opcionesRol" 
                  [value]="opcion.valor">
                  {{ opcion.etiqueta }}
                </ion-select-option>
              </ion-select>
              <ion-note slot="helper">
                Nivel de permisos del usuario en el sistema
              </ion-note>
              <ion-note slot="error" *ngIf="errores.rol">
                {{ errores.rol }}
              </ion-note>
            </ion-item>
          </div>
          
        </div>
      </ion-card-content>
    </ion-card>

    <!-- BOTONES DE ACCIÓN -->
    <div class="actions-section mt-4">
      <div class="d-flex gap-3 justify-content-end">
        
        <!-- Botón Cancelar -->
        <ion-button 
          fill="clear" 
          color="medium"
          (click)="volver()"
          [disabled]="enviandoFormulario">
          <ion-icon name="close-outline" slot="start"></ion-icon>
          Cancelar
        </ion-button>

        <!-- Botón Crear Usuario -->
        <ion-button 
          type="submit"
          fill="solid"
          color="primary"
          [disabled]="formularioUsuario.invalid || enviandoFormulario">
          <ion-icon 
            name="checkmark-outline" 
            slot="start" 
            *ngIf="!enviandoFormulario">
          </ion-icon>
          <ion-spinner 
            name="crescent" 
            slot="start" 
            *ngIf="enviandoFormulario">
          </ion-spinner>
          {{ enviandoFormulario ? 'Creando...' : 'Crear Usuario' }}
        </ion-button>
        
      </div>
    </div>

  </form>

  <!-- ESTADO DE CARGA -->
  <div class="loading-section" *ngIf="cargando">
    <div class="d-flex flex-column align-items-center justify-content-center py-5">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p class="mt-3 text-muted">Cargando formulario...</p>
    </div>
  </div>

</ion-content>